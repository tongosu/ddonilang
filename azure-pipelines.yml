trigger:
  - main
  - master

pr:
  - "*"

pool:
  vmImage: ubuntu-latest

steps:
  - script: |
      curl https://sh.rustup.rs -sSf | sh -s -- -y
    displayName: install rust
  - script: |
      python3 --version || (sudo apt-get update && sudo apt-get install -y python3)
      python3 tools/scripts/check_utf8.py || python tools/scripts/check_utf8.py
    displayName: utf8 check
  - script: |
      rc=0
      python3 tests/run_ci_sanity_gate.py --json-out build/reports/ci_sanity_gate.detjson || rc=$?
      if [ "$rc" -ne 0 ]; then
        python tests/run_ci_sanity_gate.py --json-out build/reports/ci_sanity_gate.detjson || rc=$?
      fi
      exit "$rc"
    displayName: ci sanity selftests
  - script: |
      source $HOME/.cargo/env
      cargo test -p ddonirang-core fixed64_lint_gate_no_float_in_core
    displayName: fixed64 lint gate
  - script: |
      source $HOME/.cargo/env
      cargo test -p ddonirang-core
    displayName: core tests
  - script: |
      rc=0
      fixed64_threeway_flag=""
      python3 tools/scripts/resolve_fixed64_threeway_inputs.py --report-dir build/reports --json-out build/reports/fixed64_threeway_inputs.detjson --strict-invalid || rc=$?
      if [ "$rc" -ne 0 ]; then
        python tools/scripts/resolve_fixed64_threeway_inputs.py --report-dir build/reports --json-out build/reports/fixed64_threeway_inputs.detjson --strict-invalid || rc=$?
      fi
      if [ "${DDN_REQUIRE_FIXED64_3WAY:-0}" = "1" ]; then
        fixed64_threeway_flag="--require-fixed64-3way"
      fi
      if [ -f build/reports/fixed64_cross_platform_probe_darwin.detjson ]; then
        fixed64_threeway_flag="--require-fixed64-3way"
      fi
      python3 tests/run_ci_aggregate_gate.py --report-dir build/reports --skip-core-tests --fast-fail --backup-hygiene --auto-prefix-env BUILD_BUILDID,SYSTEM_JOBID --clean-prefixed-reports --quiet-success-logs --compact-step-logs --step-log-dir build/reports --step-log-failed-only $fixed64_threeway_flag || rc=$?
      if [ "$rc" -ne 0 ]; then
        python tests/run_ci_aggregate_gate.py --report-dir build/reports --skip-core-tests --fast-fail --backup-hygiene --auto-prefix-env BUILD_BUILDID,SYSTEM_JOBID --clean-prefixed-reports --quiet-success-logs --compact-step-logs --step-log-dir build/reports --step-log-failed-only $fixed64_threeway_flag || rc=$?
      fi
      python3 tools/scripts/emit_ci_final_line.py --report-dir build/reports --print-artifacts --print-failure-digest 6 --print-failure-tail-lines 20 --fail-on-summary-verify-error --failure-brief-out build/reports/__PREFIX__.ci_fail_brief.txt --triage-json-out build/reports/__PREFIX__.ci_fail_triage.detjson || python tools/scripts/emit_ci_final_line.py --report-dir build/reports --print-artifacts --print-failure-digest 6 --print-failure-tail-lines 20 --fail-on-summary-verify-error --failure-brief-out build/reports/__PREFIX__.ci_fail_brief.txt --triage-json-out build/reports/__PREFIX__.ci_fail_triage.detjson || true
      python3 tests/run_ci_emit_artifacts_check.py --report-dir build/reports --require-brief --require-triage || python tests/run_ci_emit_artifacts_check.py --report-dir build/reports --require-brief --require-triage || rc=$?
      if [ "$rc" -eq 0 ]; then
        python3 tools/scripts/emit_ci_final_line.py --report-dir build/reports --require-final-line --fail-on-summary-verify-error --failure-brief-out build/reports/__PREFIX__.ci_fail_brief.txt --triage-json-out build/reports/__PREFIX__.ci_fail_triage.detjson || python tools/scripts/emit_ci_final_line.py --report-dir build/reports --require-final-line --fail-on-summary-verify-error --failure-brief-out build/reports/__PREFIX__.ci_fail_brief.txt --triage-json-out build/reports/__PREFIX__.ci_fail_triage.detjson || rc=$?
      fi
      exit "$rc"
    displayName: aggregate quality gate
  - task: PublishBuildArtifacts@1
    displayName: publish OI-405/406 reports
    condition: succeededOrFailed()
    inputs:
      PathtoPublish: build/reports
      ArtifactName: oi405_406_reports
