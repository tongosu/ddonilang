image: rust:1.75

stages:
  - precheck
  - test

ci-sanity:
  stage: precheck
  script:
    - apt-get update && apt-get install -y python3
    - |
      rc=0
      python3 tests/run_ci_sanity_gate.py --json-out build/reports/ci_sanity_gate.detjson || rc=$?
      if [ "$rc" -ne 0 ]; then
        python tests/run_ci_sanity_gate.py --json-out build/reports/ci_sanity_gate.detjson || rc=$?
      fi
      exit "$rc"

darwin-probe:
  stage: precheck
  rules:
    - if: '$DDN_ENABLE_DARWIN_PROBE == "1"'
  script:
    - |
      rc=0
      host="$(uname -s | tr '[:upper:]' '[:lower:]')"
      if [ "$host" != "darwin" ]; then
        echo "[ci-fixed64-darwin] DDN_ENABLE_DARWIN_PROBE=1 requires darwin agent; current=$host" >&2
        rc=2
      else
        python3 tests/run_fixed64_darwin_probe_artifact.py --require-darwin --report-dir build/reports --json-out build/reports/fixed64_darwin_probe_artifact.detjson || rc=$?
        if [ "$rc" -ne 0 ]; then
          python tests/run_fixed64_darwin_probe_artifact.py --require-darwin --report-dir build/reports --json-out build/reports/fixed64_darwin_probe_artifact.detjson || rc=$?
        fi
      fi
      exit "$rc"
  artifacts:
    when: always
    paths:
      - build/reports/fixed64_darwin_probe_artifact.detjson
      - build/reports/darwin_probe/*.detjson

core-tests:
  stage: test
  needs:
    - job: ci-sanity
    - job: darwin-probe
      optional: true
      artifacts: true
  script:
    - apt-get update && apt-get install -y python3
    - python3 tools/scripts/check_utf8.py || python tools/scripts/check_utf8.py
    - cargo test -p ddonirang-core fixed64_lint_gate_no_float_in_core
    - cargo test -p ddonirang-core
    - |
      rc=0
      fixed64_threeway_flag=""
      python3 tools/scripts/resolve_fixed64_threeway_inputs.py --report-dir build/reports --json-out build/reports/fixed64_threeway_inputs.detjson --strict-invalid --require-when-env DDN_ENABLE_DARWIN_PROBE || rc=$?
      if [ "$rc" -ne 0 ]; then
        python tools/scripts/resolve_fixed64_threeway_inputs.py --report-dir build/reports --json-out build/reports/fixed64_threeway_inputs.detjson --strict-invalid --require-when-env DDN_ENABLE_DARWIN_PROBE || rc=$?
      fi
      if [ "${DDN_REQUIRE_FIXED64_3WAY:-0}" = "1" ]; then
        fixed64_threeway_flag="--require-fixed64-3way"
      fi
      if [ "${DDN_ENABLE_DARWIN_PROBE:-0}" = "1" ]; then
        fixed64_threeway_flag="--require-fixed64-3way"
      fi
      if [ -f build/reports/fixed64_cross_platform_probe_darwin.detjson ]; then
        fixed64_threeway_flag="--require-fixed64-3way"
      fi
      python3 tests/run_ci_aggregate_gate.py --report-dir build/reports --skip-core-tests --fast-fail --backup-hygiene --auto-prefix-env CI_PIPELINE_ID,CI_JOB_ID --clean-prefixed-reports --quiet-success-logs --compact-step-logs --step-log-dir build/reports --step-log-failed-only $fixed64_threeway_flag || rc=$?
      if [ "$rc" -ne 0 ]; then
        python tests/run_ci_aggregate_gate.py --report-dir build/reports --skip-core-tests --fast-fail --backup-hygiene --auto-prefix-env CI_PIPELINE_ID,CI_JOB_ID --clean-prefixed-reports --quiet-success-logs --compact-step-logs --step-log-dir build/reports --step-log-failed-only $fixed64_threeway_flag || rc=$?
      fi
      python3 tools/scripts/emit_ci_final_line.py --report-dir build/reports --print-artifacts --print-failure-digest 6 --print-failure-tail-lines 20 --fail-on-summary-verify-error --failure-brief-out build/reports/__PREFIX__.ci_fail_brief.txt --triage-json-out build/reports/__PREFIX__.ci_fail_triage.detjson || python tools/scripts/emit_ci_final_line.py --report-dir build/reports --print-artifacts --print-failure-digest 6 --print-failure-tail-lines 20 --fail-on-summary-verify-error --failure-brief-out build/reports/__PREFIX__.ci_fail_brief.txt --triage-json-out build/reports/__PREFIX__.ci_fail_triage.detjson || true
      python3 tests/run_ci_emit_artifacts_check.py --report-dir build/reports --require-brief --require-triage || python tests/run_ci_emit_artifacts_check.py --report-dir build/reports --require-brief --require-triage || rc=$?
      if [ "$rc" -eq 0 ]; then
        python3 tools/scripts/emit_ci_final_line.py --report-dir build/reports --require-final-line --fail-on-summary-verify-error --failure-brief-out build/reports/__PREFIX__.ci_fail_brief.txt --triage-json-out build/reports/__PREFIX__.ci_fail_triage.detjson || python tools/scripts/emit_ci_final_line.py --report-dir build/reports --require-final-line --fail-on-summary-verify-error --failure-brief-out build/reports/__PREFIX__.ci_fail_brief.txt --triage-json-out build/reports/__PREFIX__.ci_fail_triage.detjson || rc=$?
      fi
      exit "$rc"
  artifacts:
    when: always
    paths:
      - build/reports/*.json
      - build/reports/*.detjson
      - build/reports/*.txt
      - build/reports/*.md
      - build/reports/*.ci_gate_step_*.stdout.txt
      - build/reports/*.ci_gate_step_*.stderr.txt
      - build/reports/*.ci_fail_brief.txt
      - build/reports/*.ci_fail_triage.detjson
      - build/reports/darwin_probe/*.detjson
